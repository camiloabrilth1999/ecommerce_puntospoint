# Ecommerce PuntosPoint - Desaf√≠o T√©cnico Backend

Sistema de ecommerce desarrollado en Ruby on Rails con API JSON, autenticaci√≥n JWT, procesamiento en segundo plano con Sidekiq y notificaciones por email.

## üìã √çndice

- [üöÄ Caracter√≠sticas Principales](#-caracter√≠sticas-principales)
- [‚öôÔ∏è Instalaci√≥n y Configuraci√≥n](#Ô∏è-instalaci√≥n-y-configuraci√≥n)
- [üîê Autenticaci√≥n](#-autenticaci√≥n)
- [üì° APIs Disponibles](#-apis-disponibles)
- [üìñ Documentaci√≥n de API con Swagger](#-documentaci√≥n-de-api-con-swagger)
- [üß™ Testing](#-testing)
- [üìà Monitoreo](#-monitoreo)
- [üõ†Ô∏è Soluci√≥n de Problemas](#Ô∏è-soluci√≥n-de-problemas)

## üöÄ Caracter√≠sticas Principales

- **API REST** con autenticaci√≥n JWT
- **Gesti√≥n de productos** con m√∫ltiples categor√≠as e im√°genes
- **Sistema de compras** con notificaciones autom√°ticas
- **Reportes diarios** automatizados con Sidekiq
- **Auditor√≠a completa** de cambios realizados por administradores
- **Optimizaci√≥n de consultas** SQL y sistema de cach√©
- **Tests completos** con RSpec
- **Preview de emails** en desarrollo con Letter Opener
- **Documentaci√≥n API** con Swagger/OpenAPI 3.0

## üìã Requerimientos del Sistema

- Ruby 3.3+
- Rails 7.2+
- PostgreSQL 12+
- Redis (para Sidekiq)
- Bundler 2.5+

### Instalaci√≥n de Dependencias del Sistema

**macOS:**
```bash
# Instalar Homebrew si no lo tienes
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Instalar dependencias
brew install postgresql redis
brew services start postgresql
brew services start redis
```

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib redis-server
sudo systemctl start postgresql
sudo systemctl start redis-server
```

## ‚öôÔ∏è Instalaci√≥n y Configuraci√≥n

### 0. Verificaci√≥n r√°pida del entorno
```bash
# Verificar que todo est√© listo
./setup_check.sh
```

### 1. Clonar el repositorio
```bash
git clone [<repository-url>](https://github.com/camiloabrilth1999/ecommerce_puntospoint.git)
cd ecommerce_puntospoint
```

### 2. Instalar dependencias
```bash
bundle install
```

### 3. Configurar base de datos
```bash
bundle exec rails db:create
bundle exec rails db:migrate
bundle exec rails db:seed
```

### 4. Verificar que Redis est√© funcionando
```bash
redis-cli ping
# Debe responder: PONG

# Si no est√° corriendo, iniciarlo:
redis-server --daemonize yes
```

### 5. Iniciar el servidor Rails
```bash
bundle exec rails server -p 3000
```

### 6. Iniciar Sidekiq (en otra terminal)
```bash
bundle exec sidekiq -v
```

### 7. Verificar que todo funciona
```bash
# Verificar el health check
curl http://localhost:3000/health

# Debe responder:
# {"status":"ok","timestamp":"2025-XX-XXTXX:XX:XXZ","environment":"development"}
```

## üóÉÔ∏è Estructura de la Base de Datos

### Modelos Principales

- **Administrator**: Usuarios administrativos con autenticaci√≥n JWT
- **Category**: Categor√≠as de productos
- **Product**: Productos del ecommerce (con m√∫ltiples categor√≠as e im√°genes)
- **Client**: Clientes que realizan compras
- **Purchase**: Compras realizadas por clientes
- **ProductCategory**: Tabla de uni√≥n para la relaci√≥n many-to-many

### Sistema de Auditor√≠a

- **PaperTrail**: Sistema de versionado autom√°tico
- **Versions**: Tabla que registra todos los cambios
- **Tracking completo**: Qu√© cambi√≥, cu√°ndo y qui√©n lo hizo

### Relaciones Avanzadas

- **Many-to-Many**: Products ‚Üî Categories (a trav√©s de ProductCategory)
- **Active Storage**: Product ‚Üí M√∫ltiples im√°genes
- **Through associations**: Product ‚Üí Clients through Purchases

## üîê Autenticaci√≥n

El sistema utiliza JWT (JSON Web Tokens) para la autenticaci√≥n de administradores.

### Credenciales por defecto:
- **Admin**: admin@puntospoint.com / password123
- **Manager**: manager@puntospoint.com / password123
- **Supervisor**: supervisor@puntospoint.com / password123
- **Test (Swagger)**: admin@test.com / password123

## üì° APIs Disponibles

### Autenticaci√≥n
```
POST /api/v1/auth/login
DELETE /api/v1/auth/logout
```

### Analytics (requieren autenticaci√≥n JWT)
```
GET /api/v1/analytics/most_purchased_by_category
GET /api/v1/analytics/top_revenue_by_category
GET /api/v1/analytics/purchases
GET /api/v1/analytics/purchases_by_granularity
```

## üîç Ejemplos de Uso de las APIs

### 1. Autenticaci√≥n
```bash
# Obtener token JWT
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "administrator": {
      "email": "admin@puntospoint.com",
      "password": "password123"
    }
  }'

# Respuesta esperada:
# {
#   "success": true,
#   "token": "eyJhbGciOiJIUzI1NiJ9...",
#   "administrator": {
#     "id": 1,
#     "name": "Admin User",
#     "email": "admin@puntospoint.com",
#     "role": "admin"
#   }
# }
```

### 2. Productos m√°s comprados por categor√≠a
```bash
curl -X GET http://localhost:3000/api/v1/analytics/most_purchased_by_category \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Respuesta esperada:
# {
#   "success": true,
#   "data": [
#     {
#       "category_id": 1,
#       "category_name": "Electr√≥nicos",
#       "product": {
#         "id": 5,
#         "name": "Air Pods Pro 2",
#         "sku": "PRD-CEE42E7E",
#         "purchase_count": 2
#       }
#     }
#   ]
# }
```

### 3. Top 3 productos con mayor recaudaci√≥n por categor√≠a
```bash
curl -X GET http://localhost:3000/api/v1/analytics/top_revenue_by_category \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 4. Listado de compras con filtros
```bash
curl -X GET "http://localhost:3000/api/v1/analytics/purchases?page=1&per_page=10" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Con filtros opcionales:
curl -X GET "http://localhost:3000/api/v1/analytics/purchases?start_date=2025-01-01&end_date=2025-01-31&category_id=1&client_id=1&administrator_id=1&page=1&per_page=10" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 5. Compras por granularidad temporal
```bash
curl -X GET "http://localhost:3000/api/v1/analytics/purchases_by_granularity?granularity=day" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Con par√°metros opcionales:
curl -X GET "http://localhost:3000/api/v1/analytics/purchases_by_granularity?granularity=day&start_date=2025-01-01&end_date=2025-01-31&category_id=1" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Script de Prueba Autom√°tica
```bash
# Ejecutar script de prueba completa
./test_apis.sh

# Debe mostrar:
# üéâ TODAS LAS PRUEBAS EXITOSAS
```

### Script de Prueba Manual
```bash
# Guardar el token en una variable
TOKEN=$(curl -s -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"administrator": {"email": "admin@puntospoint.com", "password": "password123"}}' \
  | jq -r '.token')

# Probar todas las APIs
echo "Probando API 1..."
curl -s -X GET http://localhost:3000/api/v1/analytics/most_purchased_by_category \
  -H "Authorization: Bearer $TOKEN" | jq '.success'

echo "Probando API 2..."
curl -s -X GET http://localhost:3000/api/v1/analytics/top_revenue_by_category \
  -H "Authorization: Bearer $TOKEN" | jq '.success'

echo "Probando API 3..."
curl -s -X GET "http://localhost:3000/api/v1/analytics/purchases?page=1&per_page=5" \
  -H "Authorization: Bearer $TOKEN" | jq '.success'

echo "Probando API 4..."
curl -s -X GET "http://localhost:3000/api/v1/analytics/purchases_by_granularity" \
  -H "Authorization: Bearer $TOKEN" | jq '.success'
```

## üìä Funcionalidades Avanzadas

### Notificaciones por Email
- **Primera compra**: Email autom√°tico al administrador creador del producto
- **Reportes diarios**: Resumen de compras enviado a todos los administradores
- **En desarrollo**: Los emails se abren autom√°ticamente en el navegador con Letter Opener

### Procesamiento en Segundo Plano
- **Sidekiq**: Manejo de jobs para emails y reportes
- **Cron Jobs**: Programaci√≥n de reportes diarios

### Sistema de Auditor√≠a (PaperTrail)
- **Versionado autom√°tico** de todos los cambios
- **Tracking de qui√©n hizo qu√©** y cu√°ndo
- **Historial completo** de modificaciones en productos, categor√≠as y administradores

### Optimizaciones de Performance
- **Cach√© Redis**: APIs de analytics cacheadas
- **Consultas optimizadas**: Includes y joins para evitar N+1
- **√çndices de base de datos**: Optimizaci√≥n de consultas frecuentes

## üìñ Documentaci√≥n de API con Swagger

El proyecto incluye documentaci√≥n interactiva completa usando Swagger/OpenAPI 3.0.

### üåê Acceso R√°pido
```bash
# Interfaz web interactiva:
http://localhost:3000/api-docs

# Script autom√°tico (abre en navegador):
./test_swagger.sh
```

### üîë Credenciales para Swagger UI

**Login de Prueba:**
```json
{
  "administrator": {
    "email": "admin@test.com",
    "password": "password123"
  }
}
```

**Usuarios Disponibles:**
- `admin@test.com` / `password123` (admin) - Usuario de prueba para Swagger
- `admin@puntospoint.com` / `password123` (admin) - Usuario principal
- `manager@puntospoint.com` / `password123` (manager) - Usuario manager

### üöÄ C√≥mo usar Swagger UI

#### **1. Hacer Login:**
1. Ve a `http://localhost:3000/api-docs`
2. Expande `Autenticaci√≥n` ‚Üí `POST /api/v1/auth/login`
3. Click `Try it out`
4. Pega el JSON de arriba
5. Click `Execute` y **copia el token** de la respuesta

#### **2. Autorizar la Sesi√≥n (IMPORTANTE):**
1. **Busca el bot√≥n `Authorize` üîí** en la parte superior de Swagger UI
2. Click en el bot√≥n `Authorize`
3. En el campo, pega: `Bearer [tu-token-completo]`
4. Click `Authorize` en el modal y luego `Close`

#### **3. Probar APIs:**
- Ahora todos los endpoints de Analytics funcionar√°n
- El token se incluye autom√°ticamente en cada request
- Los endpoints mostrar√°n un candado cerrado üîí

### üìä Endpoints Documentados

**üîê Autenticaci√≥n:**
- `POST /api/v1/auth/login` - Iniciar sesi√≥n y obtener token JWT
- `GET /api/v1/auth/validate` - Validar token JWT

**üìà Analytics:**
- `GET /api/v1/analytics/most_purchased_by_category` - Productos m√°s comprados por categor√≠a
- `GET /api/v1/analytics/top_revenue_by_category` - Productos con mayor facturaci√≥n por categor√≠a  
- `GET /api/v1/analytics/purchases` - Lista de compras con filtros y paginaci√≥n
- `GET /api/v1/analytics/purchases_by_granularity` - Compras agrupadas por tiempo

### ‚ú® Caracter√≠sticas
- **Interfaz interactiva** para pruebas en tiempo real
- **Autenticaci√≥n JWT integrada** con bot√≥n Authorize
- **Esquemas completos** de request/response con ejemplos
- **Validaci√≥n autom√°tica** de par√°metros
- **Documentaci√≥n siempre actualizada** (generada desde c√≥digo)

### üîß Troubleshooting Swagger
- **401 Unauthorized**: Usa el bot√≥n `Authorize` despu√©s del login
- **No veo el bot√≥n Authorize**: Refresca la p√°gina
- **Token inv√°lido**: Haz login nuevamente (tokens expiran en 24h)

## üß™ Testing

### Tests Automatizados
```bash
# Ejecutar la suite completa de tests
bundle exec rspec

# Ejecutar tests espec√≠ficos
bundle exec rspec spec/requests/api/v1/analytics_spec.rb
bundle exec rspec spec/models/product_spec.rb

# Ejecutar tests con formato detallado
bundle exec rspec --format documentation
```

### Pruebas Manuales

**Opci√≥n 1: Swagger UI (Recomendado)**
1. Ve a `http://localhost:3000/api-docs`
2. Sigue la gu√≠a de la secci√≥n "Documentaci√≥n de API con Swagger"
3. Interfaz interactiva con autenticaci√≥n integrada

**Opci√≥n 2: Script autom√°tico**
```bash
./test_apis.sh
```

**Opci√≥n 3: Postman Collection**
1. Importar `postman_collection.json` en Postman
2. Configurar variable `base_url` como `http://localhost:3000`
3. Ejecutar la carpeta "Authentication" ‚Üí "Login"
4. Ejecutar cualquier endpoint de "Analytics"

**Opci√≥n 4: Comandos curl** (ver secci√≥n de ejemplos arriba)

### Pruebas de Email

**Probar notificaciones de email:**
```bash
# Crear una compra para probar notificaci√≥n de primera compra
bundle exec rails runner "
  admin = Administrator.first
  product = Product.create!(
    name: 'Producto Test Email',
    description: 'Para probar emails',
    price: 100000,
    sku: 'EMAIL-TEST-001',
    stock: 10,
    administrator: admin,
    active: true
  )
  
  client = Client.first
  Purchase.create!(
    product: product,
    client: client,
    quantity: 1,
    unit_price: product.price,
    total_amount: product.price,
    purchase_date: Time.current,
    status: 'completed'
  )
  
  puts 'Compra creada - revisa tu navegador para el email'
"

# Probar reporte diario
bundle exec rake reports:send_daily_report
```

**üìß Los emails se abren autom√°ticamente en tu navegador** gracias a Letter Opener.

## üìà Monitoreo

### Sidekiq Web UI
Disponible en desarrollo en: `http://localhost:3000/sidekiq`

**Nota**: Si encuentras errores de CSRF al acceder a Sidekiq Web, aseg√∫rate de que el servidor Rails est√© reiniciado despu√©s de los cambios en la configuraci√≥n.

**Para generar actividad en Sidekiq Web:**
```bash
# Generar jobs de prueba
./test_sidekiq_web.sh

# O manualmente
bundle exec rake reports:send_daily_report
```

### Logs
- **Application**: `log/development.log`
- **Sidekiq**: Logs integrados en application log

## üîß Tareas de Mantenimiento

### Reportes Diarios Manuales
```bash
# Reporte del d√≠a anterior
bundle exec rake reports:send_daily_report

# Reporte de una fecha espec√≠fica
DATE=2025-01-15 bundle exec rake reports:send_daily_report
```

**üìß En desarrollo:** Los emails se abren autom√°ticamente en tu navegador gracias a Letter Opener. Tambi√©n se guardan en `tmp/letter_opener/` para revisi√≥n posterior.

### Configuraci√≥n de Cron
```bash
bundle exec rake reports:setup_cron
```

## üõ†Ô∏è Soluci√≥n de Problemas

### Redis no conecta
```bash
# Verificar si Redis est√° corriendo
redis-cli ping

# Si no responde, iniciar Redis
redis-server --daemonize yes

# En macOS con Homebrew
brew services start redis
```

### Sidekiq no procesa jobs
```bash
# Verificar conexi√≥n a Redis desde Rails
bundle exec rails runner "puts Sidekiq.redis { |conn| conn.ping }"

# Limpiar jobs fallidos
bundle exec rails runner "Sidekiq::RetrySet.new.clear; Sidekiq::DeadSet.new.clear"

# Reiniciar Sidekiq
pkill -f sidekiq
bundle exec sidekiq -v
```

### Base de datos
```bash
# Resetear base de datos (CUIDADO: borra todos los datos)
bundle exec rails db:drop db:create db:migrate db:seed

# Solo ejecutar migraciones
bundle exec rails db:migrate
```

### Tests fallando
```bash
# Limpiar y ejecutar tests
bundle exec rails db:test:prepare
bundle exec rspec --format progress
```

## üèóÔ∏è Arquitectura y Patrones

### Patrones Implementados
- **Service Objects**: L√≥gica de negocio encapsulada
- **Concerns**: Funcionalidad compartida (JwtAuthentication)
- **Jobs**: Procesamiento as√≠ncrono
- **Decorators**: Presentaci√≥n de datos

### Principios de Dise√±o
- **DRY**: Don't Repeat Yourself
- **SOLID**: Principios de dise√±o orientado a objetos
- **RESTful**: APIs siguiendo convenciones REST
- **Security First**: Validaciones y autenticaci√≥n robusta

## üìù Estructura del Proyecto

```
app/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ api/v1/
‚îÇ       ‚îú‚îÄ‚îÄ analytics_controller.rb
‚îÇ       ‚îî‚îÄ‚îÄ auth_controller.rb
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ administrator.rb
‚îÇ   ‚îú‚îÄ‚îÄ category.rb
‚îÇ   ‚îú‚îÄ‚îÄ client.rb
‚îÇ   ‚îú‚îÄ‚îÄ product.rb
‚îÇ   ‚îú‚îÄ‚îÄ product_category.rb
‚îÇ   ‚îî‚îÄ‚îÄ purchase.rb
‚îú‚îÄ‚îÄ jobs/
‚îÇ   ‚îú‚îÄ‚îÄ daily_report_job.rb
‚îÇ   ‚îî‚îÄ‚îÄ first_purchase_notification_job.rb
‚îú‚îÄ‚îÄ mailers/
‚îÇ   ‚îú‚îÄ‚îÄ daily_report_mailer.rb
‚îÇ   ‚îî‚îÄ‚îÄ first_purchase_notification_mailer.rb
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ jwt_service.rb
```

## üîí Seguridad

### Medidas Implementadas
- **JWT Authentication**: Tokens seguros con expiraci√≥n
- **Strong Parameters**: Filtrado de par√°metros
- **SQL Injection Prevention**: ActiveRecord ORM
- **XSS Protection**: Sanitizaci√≥n de datos
- **CORS Configuration**: Control de acceso cross-origin

### Validaciones
- **Email uniqueness**: Prevenci√≥n de duplicados
- **Password strength**: M√≠nimo 8 caracteres
- **Data integrity**: Validaciones de modelo completas

## üöÄ Deployment

### Variables de Entorno
```bash
export REDIS_URL=redis://localhost:6379/0
export DATABASE_URL=postgresql://user:password@localhost/ecommerce_puntospoint_production
export RAILS_MASTER_KEY=your_master_key
```

### Docker Support
El proyecto incluye Dockerfile para containerizaci√≥n.

## üìû Soporte

Para consultas t√©cnicas o dudas sobre la implementaci√≥n, contactar a:
- **Email**: camiloabrilth1999@gmial.com

---

**Desarrollado para PuntosPoint - Desaf√≠o T√©cnico Backend**
